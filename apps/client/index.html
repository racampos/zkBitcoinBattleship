<!doctype html>
<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <title>ZK Battleship</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
        background: #0a0a0a;
        color: #e0e0e0;
      }
      h1 {
        color: #4CAF50;
      }
      button {
        margin: 5px;
        padding: 10px 20px;
        font-size: 14px;
        cursor: pointer;
        border: none;
        border-radius: 4px;
        background: #2196F3;
        color: white;
      }
      button:disabled {
        background: #555;
        cursor: not-allowed;
      }
      button:hover:not(:disabled) {
        background: #1976D2;
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        background: #1a1a1a;
        border-radius: 8px;
        border: 1px solid #333;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        background: #2a2a2a;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
      }
      #controller-button {
        background: #FF5722;
        font-weight: bold;
      }
      #controller-button.connected {
        background: #4CAF50;
      }
      .game-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin: 10px 0;
      }
      .info-item {
        padding: 8px;
        background: #2a2a2a;
        border-radius: 4px;
      }
    </style>
  </head>

  <body>
    <h1>âš”ï¸ ZK Battleship on Starknet</h1>

    <!-- Connection Section -->
    <div class="section">
      <h2>ğŸ® Controller</h2>
      <button id="controller-button">Connect Wallet</button>
      <div id="account-display" class="status">Not connected</div>
    </div>

    <!-- Game Management -->
    <div class="section">
      <h2>ğŸ² Game Management</h2>
      <div>
        <button id="create-open-game-button" disabled>Create Open Game</button>
        <button id="join-game-button" disabled>Join Game (Enter ID)</button>
        <button id="refresh-game-button" disabled>Refresh Game State</button>
      </div>
      <div id="game-id-display" class="status">No game created</div>
      <div class="status" style="font-size: 11px;">
        ğŸ’¡ Share game URL: <span id="share-url"></span>
        <button id="copy-url-button" style="display: none; margin-left: 10px; padding: 5px 10px; font-size: 11px;">ğŸ“‹ Copy URL</button>
      </div>
      <div class="status" style="font-size: 12px; color: #4CAF50;">
        âœ… P1 always goes first (like white in chess). Game starts when P2 joins!
      </div>
    </div>

    <!-- Coin Flip (Hidden - Auto-start enabled) -->
    <div class="section" style="display: none;">
      <h2>ğŸª™ Coin Flip (Disabled - P1 Always Goes First)</h2>
      <button id="coin-commit-button" disabled>Commit (Start Game)</button>
      <button id="coin-reveal-button" disabled>Reveal</button>
      <div id="coin-status" class="status">Coin-flip disabled. P1 goes first automatically!</div>
    </div>

    <!-- Board Setup -->
    <div class="section" id="board-section" style="display: none;">
      <h2>ğŸ›¡ï¸ Your Defense Board</h2>
      <div class="status" style="font-size: 12px; color: #4CAF50; margin-bottom: 10px;">
        Ships: Carrier(5), Battleship(4), Cruiser(3), Submarine(3), Destroyer(2)
      </div>
      <div id="board-display" style="font-family: monospace; font-size: 14px; line-height: 1.4; background: #2a2a2a; padding: 15px; border-radius: 4px; overflow-x: auto;">
        <div id="board-grid">Loading...</div>
      </div>
      <button id="commit-board-button" disabled>Commit Board</button>
      <div id="board-status" class="status">Set up your ships...</div>
    </div>

    <!-- Dev Mode (Hidden) -->
    <div class="section" id="dev-mode-section" style="display: none; border: 2px solid #FF9800;">
      <h2>ğŸ”§ Dev Mode (Testing Shortcuts)</h2>
      <button id="skip-to-gameplay-button" disabled style="background: #FF9800;">Enable Gameplay (Skip Checks)</button>
      <div class="status" style="font-size: 11px;">âš ï¸ For single-account testing. Press Shift+D to toggle.</div>
    </div>

    <!-- Gameplay -->
    <div class="section" id="gameplay-section" style="display: none;">
      <h2>ğŸ¯ Attack Board (Track Your Shots)</h2>
      <div id="opponent-board-display" style="font-family: monospace; font-size: 14px; line-height: 1.4; background: #2a2a2a; padding: 15px; border-radius: 4px; overflow-x: auto; margin-bottom: 15px;">
        <div id="opponent-board-grid">Loading...</div>
      </div>
      
      <div id="pending-shot-display" class="status" style="background: #FF5722; display: none;">
        ğŸ¯ Opponent fired at: <span id="pending-coords">-</span>
        <button id="auto-set-coords">Set These Coords</button>
      </div>
      
      <div>
        <label>Row (A-J): <input id="shot-row" type="text" maxlength="1" value="A" style="width: 50px; text-transform: uppercase;"></label>
        <label>Column (1-10): <input id="shot-col" type="number" min="1" max="10" value="1" style="width: 60px"></label>
        <button id="random-coords-button">ğŸ² Random</button>
      </div>
      <button id="fire-shot-button" disabled>Fire Shot</button>
      <button id="apply-proof-button" disabled>Apply Proof (Defender)</button>
      <div id="game-status" class="status">No active game</div>
      <div class="status" style="font-size: 11px; color: #FFA726;">
        ğŸ’¡ Attacker fires, defender applies proof, turn flips!
      </div>
    </div>

    <!-- Game State -->
    <div class="section" id="game-state-section" style="display: none;">
      <h2>ğŸ“Š Game State</h2>
      <div class="game-info">
        <div class="info-item">Status: <span id="status-display">-</span></div>
        <div class="info-item">Turn: <span id="turn-display">-</span></div>
        <div class="info-item">P1: <span id="p1-display">-</span></div>
        <div class="info-item">P2: <span id="p2-display">-</span></div>
      </div>
      <div class="status" style="font-size: 11px;">
        ğŸ’¡ Debug: Type <code>viewGameHistory()</code> in console to see state change log
      </div>
    </div>

    <script type="module">
      import Controller from '@cartridge/controller';
      import { init, ToriiQueryBuilder, KeysClause } from '@dojoengine/sdk';
      import controllerOpts from './controller.js';
      import { initGame, updateFromEntitiesData, setGameIdFromUrl } from './game.js';
      import manifest from '../../chain/dojo/manifest_dev.json' assert { type: 'json' };

      const DOMAIN_SEPARATOR = {
        name: 'zk-battleship',
        version: '1.0',
        chainId: 'KATANA',
        revision: '1',
      };

      let currentAccount = null;

      async function run(account) {
        currentAccount = account;

        const torii = await init({
          client: {
            worldAddress: manifest.world.address,
            toriiUrl: 'http://localhost:8081', // Port 8081 (our custom port)
          },
          domain: DOMAIN_SEPARATOR,
        });

        initGame(account, manifest);

        // Subscribe to all Game model updates for this world
        const [_, subscription] = await torii.subscribeEntityQuery({
          query: new ToriiQueryBuilder().withClause(
            KeysClause(['battleship-Game'], [], 'Keys')
          ),
          callback: ({ data, error }) => {
            if (data) {
              console.log('ğŸ“¡ Torii update received:', data);
              updateFromEntitiesData(data);
            }
            if (error) {
              console.error('Torii subscription error:', error);
            }
          },
        });

        // Unsubscribe on exit
        window.addEventListener('beforeunload', () => {
          if (subscription) {
            subscription.cancel();
          }
        });

        console.log('âœ… Connected to Dojo world:', manifest.world.address);
      }

      const controller = new Controller(controllerOpts);

      document.getElementById('controller-button').onclick = async () => {
        try {
          let account = await controller.connect();

          document.getElementById('controller-button').textContent = 'Connected';
          document.getElementById('controller-button').className = 'connected';
          document.getElementById('account-display').textContent = `Address: ${account.address}`;

          // Enable buttons
          document.getElementById('create-open-game-button').disabled = false;
          document.getElementById('join-game-button').disabled = false;
          document.getElementById('refresh-game-button').disabled = false;
          document.getElementById('skip-to-gameplay-button').disabled = false;

          // Check if there's a game ID in URL
          const urlParams = new URLSearchParams(window.location.search);
          const gameIdFromUrl = urlParams.get('game');
          if (gameIdFromUrl) {
            console.log('ğŸ”— Game ID from URL:', gameIdFromUrl);
            setGameIdFromUrl(gameIdFromUrl); // Set in game.js scope
            document.getElementById('game-id-display').textContent = `Game ID (from URL): ${gameIdFromUrl.substring(0, 20)}...`;
            document.getElementById('join-game-button').textContent = 'ğŸ‘‰ Join This Game';
            document.getElementById('join-game-button').style.background = '#4CAF50';
            
            // Auto-join after a moment (no confirmation needed)
            setTimeout(() => {
              console.log('ğŸ® Auto-joining game as Player 2...');
              document.getElementById('join-game-button').click();
            }, 1000);
          }

          run(account).catch((error) => {
            console.error('Error running game:', error);
          });
        } catch (error) {
          console.error('Failed to connect:', error);
          document.getElementById('controller-button').textContent = 'Connection Failed';
        }
      };
    </script>
  </body>
</html>

